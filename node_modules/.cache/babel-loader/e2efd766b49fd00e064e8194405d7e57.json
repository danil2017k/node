{"ast":null,"code":"import mqtt from 'async-mqtt';\nconst {\n  protocol,\n  host\n} = window.location;\nconst DS_EVENTS_URL = `${protocol === 'https:' ? 'wss:' : 'ws:'}//${host}/ds-events`;\n\nclass MQTT {\n  constructor(URL) {\n    this.client = null;\n    this.URL = URL;\n    this.subscriptions = {};\n  }\n\n  async init() {\n    this.client = await mqtt.connectAsync(this.URL);\n  }\n\n  async end() {\n    await this.client.end();\n    this.client = null;\n  }\n\n  async subscribe(topic, handler) {\n    if (!this.client) {\n      await this.init();\n    }\n\n    const [mqttSubscription] = await this.client.subscribe(topic, {\n      rap: true,\n      rh: true,\n      qos: 1\n    });\n    console.log(mqttSubscription);\n    this.subscriptions[topic] = handler;\n    this.client.on('message', (topic, message) => {\n      // message is Buffer\n      if (this.subscriptions[topic]) {\n        this.subscriptions[topic](topic, JSON.parse(message));\n      }\n    });\n  }\n\n  async unsubscribe(topic) {\n    if (topic in this.subscriptions) {\n      delete this.subscriptions[topic];\n      await this.client.unsubscribe(topic);\n\n      if (!Object.keys(this.subscriptions).length) {\n        await this.end;\n      }\n    }\n  }\n\n}\n\nexport default new MQTT(DS_EVENTS_URL); // WEBPACK FOOTER //\n// ./src/utils/mqtt.js","map":{"version":3,"names":["mqtt","protocol","host","window","location","DS_EVENTS_URL","MQTT","constructor","URL","client","subscriptions","init","connectAsync","end","subscribe","topic","handler","mqttSubscription","rap","rh","qos","console","log","on","message","JSON","parse","unsubscribe","Object","keys","length"],"sources":["C:/Users/Danil/Desktop/122/src/utils/mqtt.js"],"sourcesContent":["import mqtt from 'async-mqtt'\r\n\r\nconst {\r\n  protocol,\r\n  host\r\n} = window.location\r\n\r\nconst DS_EVENTS_URL = `${protocol === 'https:' ? 'wss:' : 'ws:'}//${host}/ds-events`\r\n\r\nclass MQTT {\r\n  constructor (URL) {\r\n    this.client = null\r\n    this.URL = URL\r\n\r\n    this.subscriptions = {}\r\n  }\r\n\r\n  async init () {\r\n    this.client = await mqtt.connectAsync(this.URL)\r\n  }\r\n\r\n  async end () {\r\n    await this.client.end()\r\n    this.client = null\r\n  }\r\n\r\n  async subscribe (topic, handler) {\r\n    if (!this.client) {\r\n      await this.init()\r\n    }\r\n\r\n    const [mqttSubscription] = await this.client.subscribe(topic, { rap: true, rh: true, qos: 1 })\r\n    console.log(mqttSubscription)\r\n    this.subscriptions[topic] = handler\r\n\r\n    this.client.on('message', (topic, message) => {\r\n      // message is Buffer\r\n      if (this.subscriptions[topic]) {\r\n        this.subscriptions[topic](topic, JSON.parse(message))\r\n      }\r\n    })\r\n  }\r\n\r\n  async unsubscribe (topic) {\r\n    if (topic in this.subscriptions) {\r\n      delete this.subscriptions[topic]\r\n      await this.client.unsubscribe(topic)\r\n\r\n      if (!Object.keys(this.subscriptions).length) {\r\n        await this.end\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nexport default new MQTT(DS_EVENTS_URL)\r\n\r\n\r\n\r\n// WEBPACK FOOTER //\r\n// ./src/utils/mqtt.js"],"mappings":"AAAA,OAAOA,IAAP,MAAiB,YAAjB;AAEA,MAAM;EACJC,QADI;EAEJC;AAFI,IAGFC,MAAM,CAACC,QAHX;AAKA,MAAMC,aAAa,GAAI,GAAEJ,QAAQ,KAAK,QAAb,GAAwB,MAAxB,GAAiC,KAAM,KAAIC,IAAK,YAAzE;;AAEA,MAAMI,IAAN,CAAW;EACTC,WAAW,CAAEC,GAAF,EAAO;IAChB,KAAKC,MAAL,GAAc,IAAd;IACA,KAAKD,GAAL,GAAWA,GAAX;IAEA,KAAKE,aAAL,GAAqB,EAArB;EACD;;EAES,MAAJC,IAAI,GAAI;IACZ,KAAKF,MAAL,GAAc,MAAMT,IAAI,CAACY,YAAL,CAAkB,KAAKJ,GAAvB,CAApB;EACD;;EAEQ,MAAHK,GAAG,GAAI;IACX,MAAM,KAAKJ,MAAL,CAAYI,GAAZ,EAAN;IACA,KAAKJ,MAAL,GAAc,IAAd;EACD;;EAEc,MAATK,SAAS,CAAEC,KAAF,EAASC,OAAT,EAAkB;IAC/B,IAAI,CAAC,KAAKP,MAAV,EAAkB;MAChB,MAAM,KAAKE,IAAL,EAAN;IACD;;IAED,MAAM,CAACM,gBAAD,IAAqB,MAAM,KAAKR,MAAL,CAAYK,SAAZ,CAAsBC,KAAtB,EAA6B;MAAEG,GAAG,EAAE,IAAP;MAAaC,EAAE,EAAE,IAAjB;MAAuBC,GAAG,EAAE;IAA5B,CAA7B,CAAjC;IACAC,OAAO,CAACC,GAAR,CAAYL,gBAAZ;IACA,KAAKP,aAAL,CAAmBK,KAAnB,IAA4BC,OAA5B;IAEA,KAAKP,MAAL,CAAYc,EAAZ,CAAe,SAAf,EAA0B,CAACR,KAAD,EAAQS,OAAR,KAAoB;MAC5C;MACA,IAAI,KAAKd,aAAL,CAAmBK,KAAnB,CAAJ,EAA+B;QAC7B,KAAKL,aAAL,CAAmBK,KAAnB,EAA0BA,KAA1B,EAAiCU,IAAI,CAACC,KAAL,CAAWF,OAAX,CAAjC;MACD;IACF,CALD;EAMD;;EAEgB,MAAXG,WAAW,CAAEZ,KAAF,EAAS;IACxB,IAAIA,KAAK,IAAI,KAAKL,aAAlB,EAAiC;MAC/B,OAAO,KAAKA,aAAL,CAAmBK,KAAnB,CAAP;MACA,MAAM,KAAKN,MAAL,CAAYkB,WAAZ,CAAwBZ,KAAxB,CAAN;;MAEA,IAAI,CAACa,MAAM,CAACC,IAAP,CAAY,KAAKnB,aAAjB,EAAgCoB,MAArC,EAA6C;QAC3C,MAAM,KAAKjB,GAAX;MACD;IACF;EACF;;AA3CQ;;AA8CX,eAAe,IAAIP,IAAJ,CAASD,aAAT,CAAf,C,CAIA;AACA"},"metadata":{},"sourceType":"module"}